<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        
        async function loadBookingDetails() {
            const params = new URLSearchParams(window.location.search);
            let userId = JSON.parse(sessionStorage.getItem("user"));
            if (!userId) {
                alert("User ID not found in session storage.");
            } else {
                userId = parseInt(userId, 10);
            }
            params = new URLSearchParams(window.location.search);
            bookingId = params.get("id");

            if (!bookingId) {
                alert("No booking ID found.");
                return;
            }
            alert(`Booking ID: ${bookingId} User ID: ${userId}`);
            try {
                const response = await fetch(`http://localhost:5000/api/bookings/${bookingId}`);
                if (!response.ok) throw new Error("Failed to fetch booking");

                const data = await response.json();
                if (!data.success) throw new Error("Error: ", data.message);

                const booking = data.booking;

                if (parseInt(booking.user_id, 10) !== userId) {
                    alert("You do not have permission to edit this booking.");
                    window.location.href = "bookings.html";
                    return;
                }

                document.getElementById("roomId").value = booking.room_id;
                document.getElementById("checkIn").value = booking.check_in;
                document.getElementById("checkOut").value = booking.check_out;
                document.getElementById("paymentMethod").value = booking.payment_method;
                document.getElementById("totalPrice").value = booking.total_price;
            } catch (error) {
                console.error("Error loading booking:", error);
                alert(error.message);
            }
        }

        async function updateBooking(event) {
            event.preventDefault();

            const newRoomId = document.getElementById("roomId").value;
            const newCheckIn = document.getElementById("checkIn").value;
            const newCheckOut = document.getElementById("checkOut").value;
            const newPaymentMethod = document.getElementById("paymentMethod").value;
            const newTotalPrice = document.getElementById("totalPrice").value;

            if (!newRoomId || !newCheckIn || !newCheckOut || !newPaymentMethod || !newTotalPrice) {
                alert("Please fill all fields.");
                return;
            }

            if (new Date(newCheckOut) <= new Date(newCheckIn)) {
                alert("Check-out date must be after check-in date.");
                return;
            }

            try {
                const response = await fetch(`http://localhost:5000/api/bookings/${bookingId}`, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        room_id: newRoomId,
                        check_in: newCheckIn,
                        check_out: newCheckOut,
                        payment_method: newPaymentMethod,
                        total_price: newTotalPrice
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert("Booking updated successfully!");
                    window.location.href = "bookings.html";
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error("Error updating booking:", error);
                alert("Failed to update booking.");
            }
        }

        document.addEventListener("DOMContentLoaded", loadBookingDetails);
    </script>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto">
            <a href="/index.html" class="text-2xl font-bold">CheckIn Crew</a>
        </div>
    </nav>

    <div class="container mx-auto my-10 p-6 bg-white shadow-md rounded-lg">
        <h1 class="text-3xl font-bold mb-4">Update Booking</h1>

        <form onsubmit="updateBooking(event)">
            <label class="block">Room ID:</label>
            <input type="number" id="roomId" class="border p-2 w-full mb-3" required>

            <label class="block">Check-In Date:</label>
            <input type="date" id="checkIn" class="border p-2 w-full mb-3" required>

            <label class="block">Check-Out Date:</label>
            <input type="date" id="checkOut" class="border p-2 w-full mb-3" required>

            <label class="block">Payment Method:</label>
            <select id="paymentMethod" class="border p-2 w-full mb-3">
                <option value="cash">Cash</option>
                <option value="credit card">Credit Card</option>
                <option value="debit card">Debit Card</option>
                <option value="online">Online</option>
            </select>

            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700">Update Booking</button>
        </form>
    </div>
</body>
</html>
