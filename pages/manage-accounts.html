<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manage Accounts</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

  <!-- Navbar -->
  <nav class="bg-blue-600 text-white p-4">
    <div class="container mx-auto flex justify-between items-center">
      <a href="#" class="text-2xl font-bold">CheckIn Crew</a>
      <span class="text-lg" id="staffNameDisplay">Welcome, Admin</span>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container mx-auto my-10 p-6 bg-white shadow-md rounded-lg flex-grow">
    <h1 class="text-3xl font-bold text-center mb-6">Manage Accounts</h1>
    
    <!-- Add Staff Member Button -->
    <div class="flex justify-center mb-4">
      <button onclick="openAddStaffModal()" class="bg-green-500 hover:bg-green-700 text-white py-2 px-4 rounded-md">Add Staff Member</button>
    </div>

    <!-- User Accounts Table -->
    <h2 class="text-2xl font-semibold mb-4">User Accounts</h2>
    <div class="overflow-x-auto mb-8">
      <table class="min-w-full bg-white border border-gray-300 rounded-lg">
        <thead>
          <tr class="bg-gray-100 text-left">
            <th class="py-2 px-4 border-b">Name</th>
            <th class="py-2 px-4 border-b">Email</th>
            <th class="py-2 px-4 border-b">Account Created At</th>
            <th class="py-2 px-4 border-b">Action</th>
          </tr>
        </thead>
        <tbody id="userTableBody">
          <!-- JavaScript will populate this -->
        </tbody>
      </table>
    </div>

    <!-- Staff Accounts Table -->
    <h2 class="text-2xl font-semibold mb-4">Staff Accounts</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white border border-gray-300 rounded-lg">
        <thead>
          <tr class="bg-gray-100 text-left">
            <th class="py-2 px-4 border-b">Name</th>
            <th class="py-2 px-4 border-b">Email</th>
            <th class="py-2 px-4 border-b">Position</th>
            <th class="py-2 px-4 border-b">Salary</th>
            <th class="py-2 px-4 border-b">Hire Date</th>
            <th class="py-2 px-4 border-b">Action</th>
          </tr>
        </thead>
        <tbody id="staffTableBody">
          <!-- JavaScript will populate this -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white text-center p-4 mt-auto">
    <p>Â© 2025 CheckIn Crew. All rights reserved.</p>
  </footer>

  <!-- Add/Edit Staff Modal -->
  <div id="staffModal" class="fixed inset-0 bg-gray-500 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg w-1/3">
      <h2 class="text-2xl font-bold mb-4" id="staffModalTitle">Add Staff</h2>
      <form id="staffForm">
        <input type="hidden" id="staffId" name="staffId">
        <input type="hidden" id="userId" name="userId">
        <div class="mb-4">
          <label for="staffName" class="block text-gray-700">Name</label>
          <input type="text" id="staffName" name="staffName" class="w-full px-4 py-2 border border-gray-300 rounded-md" required>
        </div>
        <div class="mb-4">
          <label for="staffEmail" class="block text-gray-700">Email</label>
          <input type="email" id="staffEmail" name="staffEmail" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" class="w-full px-4 py-2 border border-gray-300 rounded-md" required>
        </div>
        <div class="mb-4">
          <label for="position" class="block text-gray-700">Position</label>
          <input type="text" id="position" name="position" class="w-full px-4 py-2 border border-gray-300 rounded-md" required>
        </div>
        <div class="mb-4">
          <label for="salary" class="block text-gray-700">Salary</label>
          <input type="number" id="salary" name="salary" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-md" required>
        </div>
        <div class="mb-4">
          <label for="hireDate" class="block text-gray-700">Hire Date</label>
          <input type="date" id="hireDate" name="hireDate" class="w-full px-4 py-2 border border-gray-300 rounded-md" required>
        </div>
        <div class="flex justify-end">
          <button type="button" onclick="closeStaffModal()" class="bg-gray-500 hover:bg-gray-700 text-white py-1 px-4 rounded-md mr-2">Cancel</button>
          <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white py-2 px-4 rounded-md">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div id="userModal" class="fixed inset-0 bg-gray-500 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg w-1/3">
      <h2 class="text-2xl font-bold mb-4">Edit User</h2>
      <form id="userForm">
        <input type="hidden" id="userIdEdit" name="userId">
        <div class="mb-4">
          <label for="userName" class="block text-gray-700">Name</label>
          <input type="text" id="userName" name="userName" class="w-full px-4 py-2 border border-gray-300 rounded-md" required>
        </div>
        <div class="mb-4">
          <label for="userEmail" class="block text-gray-700">Email</label>
          <input type="email" id="userEmail" name="userEmail" class="w-full px-4 py-2 border border-gray-300 rounded-md" required>
        </div>
        <div class="flex justify-end">
          <button type="button" onclick="closeUserModal()" class="bg-gray-500 hover:bg-gray-700 text-white py-1 px-4 rounded-md mr-2">Cancel</button>
          <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white py-2 px-4 rounded-md">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Set admin name from localStorage
    const staffName = localStorage.getItem("staffName");
    if (staffName) {
      document.getElementById("staffNameDisplay").textContent = `Welcome, ${staffName}`;
    }

    // Function to format date to locale string
    function formatDate(dateString) {
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) {
          console.warn('Invalid date:', dateString);
          return dateString;
        }
        return date.toLocaleString();
      } catch (error) {
        console.error('Date formatting error:', error, dateString);
        return dateString;
      }
    }

    // Fetch and populate user accounts
    async function fetchUsers() {
      try {
        console.log('Fetching users from /api/users...');
        const response = await fetch('/api/users');
        if (!response.ok) {
          throw new Error(`Failed to fetch users: ${response.statusText}`);
        }
        const { success, data: users } = await response.json();
        console.log('Users data:', users);
        if (!success) {
          throw new Error('Server returned an error');
        }
        const userTableBody = document.getElementById('userTableBody');
        userTableBody.innerHTML = '';
        if (users.length === 0) {
          userTableBody.innerHTML = `<tr><td colspan="4" class="py-2 px-4 text-center text-gray-600">No users found.</td></tr>`;
          return;
        }
        users.forEach(user => {
          userTableBody.innerHTML += `
            <tr>
              <td class="py-2 px-4 border-b">${user.name}</td>
              <td class="py-2 px-4 border-b">${user.email}</td>
              <td class="py-2 px-4 border-b">${formatDate(user.created_at)}</td>
              <td class="py-2 px-4 border-b">
                <button onclick="openEditUserModal(${user.id}, '${user.name}', '${user.email}')" class="bg-yellow-500 hover:bg-yellow-700 text-white py-1 px-4 rounded-md">Edit</button>
                <button onclick="deleteUser(${user.id})" class="bg-red-500 hover:bg-red-700 text-white py-1 px-4 rounded-md ml-2">Delete</button>
              </td>
            </tr>
          `;
        });
      } catch (error) {
        console.error('Error fetching users:', error);
        const userTableBody = document.getElementById('userTableBody');
        userTableBody.innerHTML = `<tr><td colspan="4" class="py-2 px-4 text-center text-red-600">Failed to load users. Please try again later.</td></tr>`;
      }
    }

    // Fetch and populate staff accounts
    async function fetchStaff() {
      try {
        console.log('Fetching staff from /api/staff...');
        const response = await fetch('/api/staff');
        if (!response.ok) {
          throw new Error(`Failed to fetch staff: ${response.statusText}`);
        }
        const { success, data: staff } = await response.json();
        console.log('Staff data:', staff);
        if (!success) {
          throw new Error('Server returned an error');
        }
        const staffTableBody = document.getElementById('staffTableBody');
        staffTableBody.innerHTML = '';
        if (staff.length === 0) {
          staffTableBody.innerHTML = `<tr><td colspan="6" class="py-2 px-4 text-center text-gray-600">No staff found.</td></tr>`;
          return;
        }
        staff.forEach(staffMember => {
          staffTableBody.innerHTML += `
            <tr>
              <td class="py-2 px-4 border-b">${staffMember.name}</td>
              <td class="py-2 px-4 border-b">${staffMember.email}</td>
              <td class="py-2 px-4 border-b">${staffMember.position}</td>
              <td class="py-2 px-4 border-b">$${parseFloat(staffMember.salary).toFixed(2)}</td>
              <td class="py-2 px-4 border-b">${staffMember.hire_date}</td>
              <td class="py-2 px-4 border-b">
                <button onclick="openEditStaffModal(${staffMember.staff_id}, ${staffMember.user_id}, '${staffMember.name}', '${staffMember.email}', '${staffMember.position}', ${staffMember.salary}, '${staffMember.hire_date}')" class="bg-yellow-500 hover:bg-yellow-700 text-white py-1 px-4 rounded-md">Edit</button>
                <button onclick="deleteStaff(${staffMember.staff_id})" class="bg-red-500 hover:bg-red-700 text-white py-1 px-4 rounded-md ml-2">Delete</button>
              </td>
            </tr>
          `;
        });
      } catch (error) {
        console.error('Error fetching staff:', error);
        const staffTableBody = document.getElementById('staffTableBody');
        staffTableBody.innerHTML = `<tr><td colspan="6" class="py-2 px-4 text-center text-red-600">Failed to load staff. Please try again later.</td></tr>`;
      }
    }

    // Function to attach the form submission handler
    function attachStaffFormHandler() {
      const form = document.getElementById('staffForm');
      if (!form) {
        console.error('staffForm not found!');
        return;
      }

      // Remove any existing listeners to prevent duplicates
      const newForm = form.cloneNode(true);
      form.parentNode.replaceChild(newForm, form);

      // Attach the event listener to the new form
      newForm.addEventListener('submit', async function(event) {
        event.preventDefault();

        console.log('Form submission triggered');

        // Re-fetch all fields directly from the DOM
        const staffNameInput = document.getElementById('staffName');
        if (!staffNameInput) {
          console.error('staffName input element not found!');
          alert('Internal error: Name field not found.');
          return;
        }

        const staffId = document.getElementById('staffId')?.value || '';
        const userId = document.getElementById('userId')?.value || '';
        const name = staffNameInput.value.trim();
        const email = document.getElementById('staffEmail')?.value.trim() || '';
        const position = document.getElementById('position')?.value.trim() || '';
        const salaryInput = document.getElementById('salary')?.value.trim() || '';
        let hireDate = document.getElementById('hireDate')?.value || '';

        // Debug: Log all field values and their truthiness
        console.log('Form Submission - Raw Values:');
        console.log('staffName (raw):', staffNameInput.value);
        console.log('Name (trimmed):', name, 'Truthy:', !!name);
        console.log('Email:', email, 'Truthy:', !!email);
        console.log('Position:', position, 'Truthy:', !!position);
        console.log('Salary Input:', salaryInput, 'Truthy:', !!salaryInput);
        console.log('Hire Date (raw):', hireDate, 'Truthy:', !!hireDate);

        // Fallback for hire date in MM/DD/YYYY format
        if (hireDate && !/^\d{4}-\d{2}-\d{2}$/.test(hireDate)) {
          console.log('Hire Date is not in YYYY-MM-DD format, attempting to parse...');
          const [month, day, year] = hireDate.split('/');
          if (month && day && year) {
            hireDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`; // Convert to YYYY-MM-DD
            console.log('Converted Hire Date:', hireDate);
          } else {
            console.log('Invalid date format, could not parse');
            hireDate = ''; // Reset to empty string to trigger validation error
          }
        }

        // Client-side validation with detailed error messages
        const missingFields = [];
        if (!name) missingFields.push('Name');
        if (!email) missingFields.push('Email');
        if (!position) missingFields.push('Position');
        if (!salaryInput) missingFields.push('Salary');
        if (!hireDate) missingFields.push('Hire Date');

        if (missingFields.length > 0) {
          alert(`Please fill the following required fields: ${missingFields.join(', ')}`);
          return;
        }

        const salary = parseFloat(salaryInput);
        if (isNaN(salary) || salary <= 0) {
          alert('Salary must be a positive number.');
          return;
        }

        if (!/^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i.test(email)) {
          alert('Please enter a valid email address.');
          return;
        }

        // Validate hire date format (YYYY-MM-DD)
        const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
        if (!dateRegex.test(hireDate)) {
          alert('Please select a valid hire date using the date picker (YYYY-MM-DD format).');
          return;
        }

        const payload = { name, email, position, salary, hire_date: hireDate };
        if (userId) payload.user_id = userId;

        try {
          console.log('Sending payload:', JSON.stringify(payload, null, 2));
          const url = staffId ? `/api/staff/${staffId}` : '/api/staff';
          const method = staffId ? 'PUT' : 'POST';
          const response = await fetch(url, {
            method,
            headers: {
              'Content-Type': 'application/json',
              // Uncomment and add authentication token if required
              // 'Authorization': `Bearer ${localStorage.getItem('authToken')}`
            },
            body: JSON.stringify(payload)
          });

          const result = await response.json();
          if (!response.ok) {
            throw new Error(result.message || `Failed to ${staffId ? 'update' : 'add'} staff: ${response.statusText}`);
          }
          if (!result.success) {
            throw new Error(result.message || 'Server returned an error');
          }

          console.log('Staff operation successful:', result);
          await fetchStaff();
          closeStaffModal();
        } catch (error) {
          console.error(`Error ${staffId ? 'updating' : 'adding'} staff:`, error);
          alert(`Failed to ${staffId ? 'update' : 'add'} staff: ${error.message}`);
        }
      });
    }

    // Open add staff modal
    function openAddStaffModal() {
      console.log('Opening Add Staff Modal');
      const modal = document.getElementById('staffModal');
      const form = document.getElementById('staffForm');
      const staffNameInput = document.getElementById('staffName');

      if (!modal || !form || !staffNameInput) {
        console.error('Required elements not found:', {
          modal: !!modal,
          form: !!form,
          staffNameInput: !!staffNameInput
        });
        alert('Internal error: Form elements not found.');
        return;
      }

      // Show the modal
      modal.classList.remove('hidden');
      document.getElementById('staffModalTitle').textContent = 'Add Staff';

      // Reset the form
      form.reset();

      // Explicitly clear all fields
      document.getElementById('staffId').value = '';
      document.getElementById('userId').value = '';
      staffNameInput.value = '';
      document.getElementById('staffEmail').value = '';
      document.getElementById('position').value = '';
      document.getElementById('salary').value = '';
      document.getElementById('hireDate').value = '';

      // Debug: Confirm the staffName field is empty after reset
      console.log('After reset - staffName value:', staffNameInput.value);

      // Attach the form submission handler
      attachStaffFormHandler();
    }

    // Open edit staff modal
    function openEditStaffModal(staffId, userId, name, email, position, salary, hireDate) {
      const modal = document.getElementById('staffModal');
      modal.classList.remove('hidden');
      document.getElementById('staffModalTitle').textContent = 'Edit Staff';
      document.getElementById('staffId').value = staffId;
      document.getElementById('userId').value = userId;
      document.getElementById('staffName').value = name;
      document.getElementById('staffEmail').value = email;
      document.getElementById('position').value = position;
      document.getElementById('salary').value = salary;
      document.getElementById('hireDate').value = hireDate;

      // Attach the form submission handler
      attachStaffFormHandler();
    }

    // Close staff modal
    function closeStaffModal() {
      document.getElementById('staffModal').classList.add('hidden');
    }

    // Open edit user modal
    function openEditUserModal(userId, name, email) {
      document.getElementById('userModal').classList.remove('hidden');
      document.getElementById('userIdEdit').value = userId;
      document.getElementById('userName').value = name;
      document.getElementById('userEmail').value = email;
    }

    // Close user modal
    function closeUserModal() {
      document.getElementById('userModal').classList.add('hidden');
    }

    // Handle user form submission (edit)
    document.getElementById('userForm').addEventListener('submit', async function(event) {
      event.preventDefault();
      const userId = document.getElementById('userIdEdit').value;
      const name = document.getElementById('userName').value.trim();
      const email = document.getElementById('userEmail').value.trim();

      // Client-side validation
      const missingFields = [];
      if (!name) missingFields.push('Name');
      if (!email) missingFields.push('Email');

      if (missingFields.length > 0) {
        alert(`Please fill the following required fields: ${missingFields.join(', ')}`);
        return;
      }

      if (!/^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i.test(email)) {
        alert('Please enter a valid email address.');
        return;
      }

      try {
        const response = await fetch(`/api/users/${userId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email })
        });
        const result = await response.json();
        if (!response.ok) {
          throw new Error(result.message || `Failed to update user: ${response.statusText}`);
        }
        if (!result.success) {
          throw new Error(result.message || 'Server returned an error');
        }
        await fetchUsers();
        closeUserModal();
      } catch (error) {
        console.error('Error updating user:', error);
        alert(`Failed to update user: ${error.message}`);
      }
    });

    // Delete user
    async function deleteUser(userId) {
      if (!confirm('Are you sure you want to delete this user?')) return;
      try {
        const response = await fetch(`/api/users/${userId}`, {
          method: 'DELETE'
        });
        if (!response.ok) {
          throw new Error(`Failed to delete user: ${response.statusText}`);
        }
        await fetchUsers();
      } catch (error) {
        console.error('Error deleting user:', error);
        alert('Failed to delete user. Please try again.');
      }
    }

    // Delete staff
    async function deleteStaff(staffId) {
      if (!confirm('Are you sure you want to delete this staff member?')) return;
      try {
        const response = await fetch(`/api/staff/${staffId}`, {
          method: 'DELETE'
        });
        if (!response.ok) {
          throw new Error(`Failed to delete staff: ${response.statusText}`);
        }
        await fetchStaff();
      } catch (error) {
        console.error('Error deleting staff:', error);
        alert('Failed to delete staff. Please try again.');
      }
    }

    // Initialize tables
    fetchUsers();
    fetchStaff();
  </script>
</body>
</html>